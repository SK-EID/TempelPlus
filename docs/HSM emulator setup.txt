Setup for HSM emulator (Windows, 32bit Java)

1.	Copy the “cryptoki” folder from HSM emulator’s distribution package to your C:\ disk drive. 

2.	Adding certificates and key pairs to HSM emulator: 
a.	Make a slot with HSM Admin utility program and initialize the slot. 
b.	Place the certificate and its private key to a PKCS#12 container. 
c.	Import the PKCS#12 container file to the appropriate slot in the HSM emulator by using ctkmu.exe utility program (attributes S (signing) and D (decryption) have to be set according to your certificate’s allowed usage purpose. In order to modify the certificate and private key objects later then the attribute M (modifiable) should also be set). 

For example:
ctkmu.exe j --slot-num=4 --name=TPL_sign_04 --attributes=PMTSV C:\p12\Kristi_Tempel_2K.p12

ctkmu.exe j --slot-num=4 --name=TPL_enc_04 --attributes=PMTDV C:\p12\Kristi_Krupto_2K.p12

Note: the private key and certificate have to be in the same slot, their label names have to match (when importing a PKCS#12 container with ctkmu.exe utility program then the label names of all the objects in the container are set according to the value of --name attribute). Certificate’s and its private key’s label name has to be unique in the range of a particular slot. 

Note that when importing objects to a slot then the slot number has to be set according to the slot’s ID. Slot ID can be determined with pkcs11-tool.exe utility program (for example: pkcs11-tool --module cryptoki.dll –L), the ID value is marked as a hexadecimal number.
Note: if it is necessary to use the HSM device or HSM emulator with the same command as is used with USB token (i.e. without determining the –slot and –label parameters) then the certificate and its private key objects in a HSM slot have to have matching ID values. The ID value can be determined (and modified) with Cryptoki Token Browser application when logging in to the appropriate slot.

3.	Configure TempelPlus:

a.	Set the value of DIGIDOC_SIGN_PKCS11_DRIVER parameter in TempelPlus configuration file according to the cryptoki.dll PKCS#11 driver’s file location in your file system. The location should also be added to Path system variable. 
b.	Optionally set the pin parameter in TempelPlus.conf file according to the PIN code of the HSM slot where your certificate is located (if the PIN code is not provided from command line). 
